# 消息系统性能测试
测试使用kafka自带测试脚本工具
## Producer

```
> .\bin\windows\kafka-producer-perf-test.bat --topic test1 --num-records 50000000 --throughput 10000000 --record-size 16 --producer.c
onfig .\config\producer.properties
```

| 消息数 | 每条消息数据量(Byte) | 平均每秒写record数 | 吞吐量(MB/s) | 平均延迟(ms) | 最大延迟(ms) | server分区数 | socket buffer大小(Byte) |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| 50000000 | 16 | 2700950.73 | 41.21 | 0.91 | 115 | 1 | 102400 |
| 50000000 | 32 | 2381746.30 | 72.69 | 0.96 | 98 | 1 | 102400 |
| 50000000 | 64 | 1397155.39 | 85.28 | 7.56 | 221 | 1 | 102400 |
| 50000000 | 16 | 2573207.76 | 39.26 | 0.88 | 103 | 10 | 102400 |
| 50000000 | 32 | 2278215.70 | 69.53 | 1.08 | 213 | 10 | 102400 |
| 50000000 | 64 | 1358843.35 | 82.94 | 5.54 | 381 | 10 | 102400 |
| 50000000 | 16 | 2206628.71 | 33.67 | 1.71 | 102 | 10 | 1024 |
| 50000000 | 32 | 1459896.64 | 44.55 | 1.64 | 97 | 10 | 1024 |
| 50000000 | 64 | 837436.77 | 51.11 | 1.7 | 139 | 10 | 1024 |


## Consumer

```
.\bin\windows\kafka-consumer-perf-test.bat --broker-list localhost:9092 --messages 50000000 --topic test1 --threads 1 --num-fetch-t
hreads 1
```

| 消息数 | 处理线程数 | fetch线程数 | 消耗消息大小| 吞吐量(MB/s) | 平均每秒读消息数 | rebalance耗时(ms) | fetch耗时(ms) | fetch速度(MB/s) | fetch速度(条/秒) | server分区数 | socket buffer大小(Byte) |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| 50000000 | 10 | 1 | 1525.8860 | 147.0167 | 4817442.23 | 9 | 10370 | 147.1443 | 4821623.24 | 1 | 102400
| 50000000 | 10 | 1 | 1525.8860 | 145.5720 | 4770104.27 | 11 | 10471 | 145.725 | 4775115.36 | 10 | 102400
| 50000000 | 10 | 2 | 1525.8860 | 144.4694 | 4733973.96 | 10 | 10552 | 144.6063 | 4738460.29 | 10 | 102400
| 50000000 | 10 | 4 | 1525.8860 | 151.6785 | 4970202.08 | 10 | 10050 | 151.8295 | 4975147.56 | 10 | 102400
| 50000000 | 1 | 4 | 1525.8860 | 148.5915 | 4869045.96 | 10 | 10259 | 148.7363 | 4873792.08 | 10 | 102400
| 50000000 | 1 | 4 | 1525.8860 | 148.5915 | 4869045.96 | 10 | 10259 | 148.7363 | 4873792.08 | 10 | 102400
| 50000000 | 10 | 1 | 1525.8860 | 147.5997 | 4836547.97 | 11 | 10327 | 147.7569 | 4841699.71 | 10 | 1024
| 50000000 | 10 | 4 | 1525.8860 | 146.9317 | 4814658.93 | 9 | 10376 | 147.0592 | 4818835.1 | 10 | 1024
| 50000000 | 1 | 4 | 1525.8860 | 146.5789 | 4803096.34 | 11 | 10399 | 146.7339 | 4808177.03 | 10 | 1024


## 测试结果分析
对于producer和consumer的测试中，都加以改变的变量是server分区数(partition)和socket buffer大小。
在其他条件保持一致的情况下，当分区数增加，producer和consumer的吞吐量都有一定程度的下降，延迟有一定程度的增加。这可能是因为在增加分区数之后，目标文件增多，消息被写入了更多分散的文件，在对文件系统作读写操作时，由于文件数增多，I/O操作的次数也有所增加，因此在读写文件上花费了更多时间，使得吞吐量变低。而socket buffer数量的减小也同样导致了，读写同样大小的消息，需要分更多次文件读写操作来完成，所以I/O操作占用了更多时间，吞吐量变低。</br>
Producer还改变了每条消息数据量这个参数，在其他条件保持一致的情况下，当每条消息数据量增加，producer的吞吐量随之上升，延迟下降。和上面的理由类似，可能是因为每条消息数据量的增加使得发送同样数据量需要的文件读写次数下降，减少了I/O操作，因此可以提升性能。</br>
Consumer分别改变了处理线程数和fetch线程数，从测试结果可以看出，增加fetch线程数可以略微提高吞吐量，降低平均延迟，而增加处理线程数反而使得吞吐量降低，平均延迟增大。</br>
</br>
此外，我还测试了在不同电脑上跑相同测试的结果，然而和预期结果相差较大，一台电脑是的型号是联想Y7000，另一台电脑是mac pro 2017，首先做了I/O性能测试：</br>联想Y7000 的测试结果是读取速度平均为1500MB/s，写入速度平均为650MB/s</br>mac pro 2017 的测试结果是读取速度平均为2442MB/s,写入速度平均为1232MB/s</br>
在预期情况下，跑相同的测试，mac的吞吐量及延迟都应该领先联想Y7000，然而实际上测试的结果是联想Y7000各项指标均比mac pro高出1/3左右，这完全超出了我的预期，可能是由于我的测试方法不正确导致。
